# 资源添加

## 静态资源

###添加文件

```
将静态资源的文件夹及文件置于ihome/ihome/static中，形成如下目录

# 项目/ihome/static目录		 说明
	/css/					项目css文件
	/html/					项目html文件
	/images/				项目images文件				
	/js/					项目js文件
	/plugins/				项目前端插件--bootstrap、switch、swiper等
	favicon.ico				项目logo
```

### 创建蓝图

`ihome/home/web.py`

```
# coding:utf-8

from flask import Blueprint
from flask import current_app

# 创建蓝图对象
# 参数1：蓝图名称；参数2：蓝图所在位置
html = Blueprint('html', __name__)


# GET 127.0.0.1:5000/
# GET 127.0.0.1:5000/index.html
# GET 127.0.0.1:5000/register.html
# GET 127.0.0.1:5000/要访问的html文件名
# 浏览器自动发送的请求网站log
# GET 127.0.0.1:5000/favicon.ico

# 在flask中从请求路径中提取html文件名需要用转换器
# @html.route('/<str:file_name>')，无法满足无文件名情况
# 需要自定义实现正则转换器，放置于utils/commons.py
@html.route('/<re(r".*"):file_name>')
def get_html_file(file_name):
    """提供静态的html文件资源"""
    # 从请求的路径中提取html文件名
    # 去html目录中找到文件并返回给用户

    # 若file_name为空
    if not file_name:
        file_name = "index.html"
	# 当请求不是网站log
	if filename != "favicon.ico":
    	file_name = "html/" + file_name

    # send_static_file(静态目录中的文件名)，
    # 函数会自动去静态目录中找文件，返回包含文件内容的响应信息
    return current_app.send_static_file(file_name)
```

### 自定义正则转换器

`ihome/ihome/utils/commons.py`

```
# coding:utf-8

from werkzeug.routing import BaseConverter

class ReConverter(BaseConverter):
    """自定义正则转换器"""
    def __init__(self, url_map, regex):
        super(ReConverter, self).__init__(url_map)
        self.regex = regex
```

### 注册正则转换器和蓝图

`ihome/ihome/__init__.py`

```
from ihome.utlis.commons import ReConverter

def create_app(run_name):
	...
	# 注册自定义的正则转化器
    app.url_map.converters["re"] = ReConverter
    
	# 注册静态文件蓝图,由于不加前缀，故不许url_prefix
    from ihome import web_page
    app.register_blueprint(web_page.html)
```

### 设置cookie中csrf_token

由于在客户端向服务器请求csrf验证之情就应创建好cookie中的csrf_token值，故在客户端访问静态页面时设置

`ihome/home/web.py`

```
# 构造响应对象
from flask import make_response
# 导入csrf生成随机字符串
from flask_wtf import csrf
...
def get_html_file(file_name):
	...
	# send_static_file(静态目录中的文件名)， 函数会自动去静态目录中找文件，返回包含文件内容的响应信息
    # make_response()构造响应对象，接收响应体数据，可以是字符串，文件内容
    resp = make_response(current_app.send_static_file(file_name))

    # 生成csrf_token随机字符串的值
    csrf_token = csrf.generate_csrf()

    # 设置csrf用到的cookie
    # 参数1：键名；参数2：随机字符串的值
    resp.set_cookie("csrf_token", csrf_token)

    return resp
```

## 图片验证码capture

```
将capture包置于ihome/ihome/utils/下
```

###创建验证码视图

`ihome/ihome/api_v1_0/verify_code.py`

```
# coding:utf-8

# 导入蓝图
from . import api
# 导入captcha，生成验证码
from ihome.utils.captcha import captcha
# 导入redis连接实例
from ihome import redis_store
# 导入常量信息
from ihome import constants
# 导入日志写入功能
from flask import current_app
# 导入json数据转换
from flask import jsonify
# 导入响应对象
from flask import make_response
# 导入状态码信息
from ihome.utils.response_code import RET


# GET /image_codes/图片验证码编号
@api.route("/image_codes/<image_code_id>")
def get_image_code(image_code_id):
    """提供图片验证码
    1.导入使用captcha扩展包，生成图片验证码
    2.在服务器中保存图片验证码(验证码编号和真实值)到redis中
    3.若保存失败，返回错误信息，记录日志current_app
    4.返回图片，使用make_response对象
    """
    # 生成验证码图片
    # 名字 真是验证码 验证码图片
    name, text, image_data = captcha.generate_captcha()

    # 保存验证码的真实值和这个验证码编号至redis中,有效期
    # redis数据类型：string,list,hash,set...，此处使用string
    # key:val
    # "image_code_编号1"："真实值"
    # "image_code_编号2"："真实值"
    # redis_store.set("image_code_%s" % image_code_id, text)
    # redis_store.expire("image_code_%s" % image_code_id, 300)
    try:
        redis_store.setex("image_code_%s" % image_code_id, constants.IMAGE_CODE_REDIS_EXPIRES, text)
    except Exception as e:
        # flask写入日志的方法：current_app.logger或app.logger
        current_app.logger.error(e)
        return jsonify(errno=RET.DBERR, errmsg="数据库异常")
    # 返回验证码图片
    # 方法一：直接返回多个值
    # return image_data, 200, {"Content-Type": "image/jpg"}
    # 方法二：使用make_response对象
    else:
        # 使用响应对象返回图片
        response = make_response(image_data)
        # 设置响应的数据类型
        response.headers['Content-Type'] = "image/jpg"
        # 返回结果
        return response
```

### 常量信息

`ihome/ihome/utils/constants.py`

```
# coding:utf-8


# 图片验证码在redis中保存的有效期，单位：秒
IMAGE_CODE_REDIS_EXPIRES = 300
```

## 短信验证云通讯



## 图片存储七牛云



