# 常用技术

## 中间件

MIDDLEWARE: 中间件

一、案例： 禁止指定ip地址的访问

使用request对象的META属性，可以获取用户访问的ip地址：

```
request.META.get('REMOTE_ADDR')
```

二、中间件

中间件： django框架预留的接口，可以控制请求和响应的过程。Django在中间件中预置了6个方法，这些方法会在不同的阶段执行，对输入或输出进行干预。

- 初始化：无需任何参数，服务器响应第一个请求的时候调用一次：

```
def init():
    pass
```

- 处理请求前(url匹配前)调用： 返回None或HttpResponse对象

```
def process_request(self, request):
    pass
```

- url匹配后视图函数处理前调用： 返回None或HttpResponse对象

```
def process_view(self, request, view_func, view_args, view_kwargs):
    pass
```

- 视图函数出异常时调用：**返回一个HttpResponse对象**

```
def process_exception(self, request, exception):
    return response
```

- 视图函数处理后，模板响应处理前调用： 返回实现了render方法的响应对象

```
def process_template_response(self, request, response):
    pass
```

视图函数返回TemplateReponse时才会调用，返回HttpResponse对象不会调用

- 视图函数处理后，返回内容给浏览器前调用：**返回HttpResponse对象**

```
def process_response(self, request, response):
    return response
```

### 中间件的使用

1. 定义中间件类：

   在app01应用下创建模块：midlleware.py， 在里面创建中间件类如下：

```python
class MyMiddleware(object):
    def __init__(self):
        print('--init--')

    def process_request(self, request):
        print('--process_request--')

    def process_view(self, request, view_func, view_args, view_kwargs):
        print('--process_view--')

    def process_response(self, request, response):
        print('--process_response--')
        return respons
```

2. views.py文件的进入首页视图函数，打印日志:

```
def index(request):
    """进入首页"""
    print('=====index视图函数====')
    return HttpResponse(request, 'app01/index.html')
```

3. 在setting.py中注册中间件类：

```
# setting.py
MIDDLEWARE_CLASSES = (
    ...
    'django.middleware.security.SecurityMiddleware',
    # 注册自定义中间件
    'app01.middleware.MyMiddleware',
)
```

4. 访问首页，会输出如下结果： 

```
--init
--process_request
--process_view
--index--
--process_response
```

### 禁用ip功能

1. 在MyMiddleware的process_view方法中，新增代码如下：

```
class MyMiddleware(object):
   ...
	exclude_ips = ['127.0.0.1']
    def process_view(self, request, view_func, view_args, view_kwargs):
        print('--process_view--')

		# 禁用ip，以下代码也可以添加到process_request方法
        ip = request.META.get('REMOTE_ADDR')
        if ip in exclude_ips:
            return HttpResponse('禁止访问')
```

 注意：process_view返回了HttpResponse对象之后，视图函数就不会再执行了。

### 异常处理

异常处理： 视图函数执行出错之后，会调用中间件的process_exception方法，可以在该方法中执行异常操作	

1. 在index视图函数中，添加执行出错代码：

```
def index(request):
    """进入首页"""
    print('=====index====')

	# 添加出错代码
    aa = None
    print('aa='+ aa)
    
	return render(request, 'app01/index.html')
```

2. 在前面编写的MyMiddleware中： 添加处理异常的中间件方法，并注释前面的拦截ip的拦截： 

```python
# middleware.py
class MyMiddleware(object):
	...

    def process_view(self, request, view_func, view_args, view_kwargs):
        print('-------process_view')
        # # 禁止ip访问
        # ip = request.META.get('REMOTE_ADDR')
        # if ip in exclude_ips:
        #     return HttpResponse('禁止访问')

    def process_exception(self, request, exception):
        print('-----process_exception')
```

3. 访问首页，查看服务器，发现：处理异常的中间件方法`process_exception`执行了
4. 处理出错： 在process_exception方法中返回HttpResponse对象就可以了： 

```
# middleware.py
class MyMiddleware(object):
	...
    def process_exception(self, request, exception):
        print('-----process_exception')
		return HttpResponse('运行出错了：%s' % exception)
```

### 多个中间件的调用流程

- 视图函数之前执行的`process_request`和`process_view`方法：先注册的中间件会先执行
- 视图函数之后执行的`process_exception`和`process_response`方法：后注册的中间件先执行

代码测试： 

1. 再写一个中间件：

```python
class MyMiddleware2(object):
    def __init__(self):
        print('-------init2')

    def process_request(self, request):
        print('-------process_request2')

    def process_view(self, request, view_func, view_args, view_kwargs):
        print('-------process_view2')

    def process_response(self, request, response):
        print('-------process_response2')
        return response

    def process_exception(self, request, exception):
        print('-----process_exception2')
```

2. 在setting.py中注册中间件类：

```python
# setting.py
MIDDLEWARE_CLASSES = (
    ...
    'django.middleware.security.SecurityMiddleware',
    # 注册自定义中间件
    'app01.middleware.MyMiddleware',
    'app01.middleware.MyMiddleware2',
)
```

小结：某个中间件处理异常的方法返回HttpResponse对象后，其它中间件的处理异常的方法就不会执行了。