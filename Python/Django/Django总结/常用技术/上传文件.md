## 上传文件

### 基础知识

```
1. 安装相关的第三方模块
2. 图片上传先关模型类配置
3. 数据迁移操作
4. 上传目录配置

```

在Django中上传图片包括两种方式：

```
在管理页面admin中上传图片
自定义form表单中上传图片
```

上传图片后，将图片存储在服务器磁盘中，然后将图片的路径存储在数据库表中

### 基本环境配置

- 安装相关第三方模块

在python中进行图片操作，需要安装包PIL

```
pip install Pillow==3.4.1
```

- 模型类配置

创建包含图片的模型类，将模型类的属性定义为models.ImageField类型

```
# models.py
class PicInfo(Model):
    """上传图片"""

    # upload_to指明该字段的图片保存在MEDIA_ROOT目录中的哪个子目录
    pic_path = models.ImageField(upload_to='app01')

    # 自定义模型管理器
    objects = PicInfoManager()
```

- 生成迁移

```
python manage.py makemigrations
python manage.py migrate
```

- 上传目录配置

```
# setting.py
MEDIA_ROOT = os.path.join(BASE_DIR, 'static/media')
```

在static下创建上传图片保存的目录

```
media/app01
```

### 管理后台上传

注册模型类，以便在后台中显示出来： 

```
# app01.admin.py
from django.contrib import admin
from app01.models import PicInfo
admin.site.register(PicInfo)
```

使用创建的用户名和密码

登录进入后台，新增一条记录，进行图片上传

### 自定义表单上传

点击`http://127.0.0.1:8000/upload/`进入上传界面

- url

```python
# app01/urls.py
urlpatterns = [
    ...
    url(r'^upload/$', views.upload),                # 进入图片上传界面
    url(r'^do_upload/$', views.do_upload),          # 处理图片上传操作
]

```

- 视图函数

```python
# views.py
def upload(request):
    """进入上传文件界面"""
    return render(request, 'app01/02.upload.html')

# views.py
def do_upload(request):
    """处理文件上传操作"""
    # 获取上传的文件对象
    pic_file = request.FILES.get('pic')
    # 定义文件的保存路径
    file_path = '%s/app01/%s' % (settings.MEDIA_ROOT, pic_file.name)
    # 保存上传的文件内容到磁盘中(with as 会自动关闭文件)
    with open(file_path, 'wb') as file:
        for data in pic_file.chunks():
                file.write(data)
    # 保存上传的文件路径到数据库中
    pic_info = PicInfo()
    pic_info.pic_path = 'app01/%s' % pic_file.name
    pic_info.save()
    # 响应浏览器内容
    return HttpResponse('文件上传成功')

```

- html

```html
# templates/app01/02.upload.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>上传图片</title>
</head>
<body>
<form method="post" enctype="multipart/form-data" action="/do_upload/">
    {% csrf_token %}
    选择文件：<input type="file" name="pic"/><br/>
    <input type="submit" value="上传">
</form>
</body>
</html>

```

### 显示用户上传的图片

url

```python
urlpatterns = [
    ...     
    url(r'^show_image/$', views.show_image),   # 进入显示图片界面
]

```

view

```python
def show_image(request):
    """进入显示图片界面"""

    # 从数据库中查询出所有的图片
    pics = PicInfo.objects.all()
    data = {'pics': pics}
    return render(request, 'app01/03.show_image.html', data)
```

html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>使用上传的图片</title>
</head>

<body>
显示用户上传的图片：<br/>

{% for pic in pics %}
    <img src="/static/media/{{ pic.pic_path }}"> <br/>
{% endfor %}

</body>
</html>
```

## 