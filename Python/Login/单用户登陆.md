# 单用户登陆

## session

[参考](https://blog.csdn.net/u014633966/article/details/85414656)

用户新登录后，从记录session的数据库中删除之前的记录

```
.....
login(request, user) #登录成功
# 登录之后获取获取最新的session_key
session_key = request.session.session_key
# 删除非当前用户session_key的记录
for session in Session.objects.filter(~Q(session_key=session_key), expire_date__gte=timezone.now()):
    data = session.get_decoded()
    if data.get('_auth_user_id', None) == str(request.user.id):
        session.delete()
```

## 新表

[参考](https://www.cnblogs.com/zzqit/p/10610570.html)

```python
from django.shortcuts import redirect
from django.views.decorators.cache import never_cache
from django.views.decorators.csrf import csrf_exempt
from django.contrib.auth import login as auth_login, authenticate
from app01.models import UCenter  # 用户信息表


@csrf_exempt
@never_cache
def login(request):
    if request.user.is_authenticated():
        return redirect('/index/')
    else:
        if request.method == "POST":
            username = request.POST.get("username")
            password = request.POST.get("password")
            authenticated_user = authenticate(username=username, password=password)
            if authenticated_user:
                # 单用户登录
                user_obj = UCenter.objects.filter(userid=authenticated_user)  # 找到登录的user对象
                is_session_key = user_obj.first().session_key  # 获取登录对象的session_key
                if is_session_key:  # 用户已登录
                    request.session.delete(is_session_key)  # 删除登录前面登录用户的session_key
                auth_login(request, authenticated_user)  # 用户信息存入session
                user_obj.update(session_key=request.session.session_key)  # 更新新登录user的session_key
                return redirect('/index/')
            else:
                return redirect('/accounts/login/')
```

[参考](https://blog.csdn.net/qq_42735170/article/details/82225771)

```python
def the_one(func):
    '''自定义 验唯一证在线 装饰器'''
    def check_login_status(request):
        if request.session.get('qq', None):
            try:
                hert = request.session.get('hert', None)
data=models.Users.objects.filter(qq=request.session.get('qq',None)).values('business_card').first()
                if str(hert) == str(data['business_card']):
                    return func(request)
                else:
                    return redirect('/login/')
            except:
                return redirect('/login/')
        else:
            return redirect('/login/')

```

