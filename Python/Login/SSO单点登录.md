## 单点登录

单点登录（Single Sign On，SSO）常用于多服务器共存的大型网站，即一次用户认证，即可访问旗下所有网站。

以[豆瓣网](https://www.douban.com/)为例，它有[豆瓣读书](https://book.douban.com/)、[豆瓣电影](https://movie.douban.com/)子网站，这两个子网站部署在不同服务器上。

### 基于Token的认证

首先，用户数据不能放在Session里，所以基于Token的认证方式很快进入我们的视野，也就是版本2和版本3的认证方式。需要注意的是，不同服务器必须使用**同一个缓存系统**。可以单独起一个服务器用作数据存储。这样一来，系统都可以根据`token`从缓存系统中解析出`用户实例`。

### 同源：共享Cookie

仔细的同学会发现，版本3的`token`是存在Session里的，就算在子网A中登录完了，在子网B的Session中并没有这个`token`。一个常见的做法是共享Cookie，让子网A的Cookie可以让子网B使用，再将`token`放在Cookie中，而不是放在Session里。

例如豆瓣读书域名为：book.douban.com，豆瓣电影域名为：movie.douban.com，现在要种一个Cookie，使得这两个域名都能使用。因为他们是属于同一个二级域名`douban.com`下的，所以可以让用户在域名www.douban.com下登录，把Cookie的路径设置为`.douban.com`，即可实现Cookie的共享。

### 跨域：统一认证网站

如果遇到[www.taobao.com和www.douban.com要做统一身份认证怎么办呢？因为没有共同的二级域名，所以将认证系统建于第三个网站中，这个网站也叫统一认证网站（简称认证网）。

我们先假设一个未登录的用户。

1. 第一次请求。请求网站A的`/home`网页，网站A检测出用户未登录，于是使用HTTP重定向，引导用于至认证网的登录页面去。
2. 第二次请求。这是由浏览器自主发起的，认证网响应出登录页面。
3. 第三次请求。用户输入账号密码进行登录，服务器认证成功后，种下Cookie，并重定向至网站的A的`/home`页面，但是带上了`token`。接收此次响应后，浏览器已有了认证网的Cookie，所以用户在认证网处于登录状态。
4. 第四次请求。浏览器自主发起的，网站A必须识别出`token`参数，并保存起来。在响应中，种下网站A的Cookie。此时用户在网站A也处于登录状态。

我们假设这个已经认证过的用户，去访问网站B。

可以看到，在引导用户至认证网的登录页面时，因为用户在认证网处于登录状态，所以认证网直接重定向到网站B的`/profile`页面。

有朋友会发现，认证网的功能其实可以融合到网站A或网站B中。确实可以这样做，但是不推荐，因为要秉持低耦合的原则，将认证系统独立出来会更加方便使用和管理。

进一步理解，使用OAuth协议也可以实现单点登录功能，它就是API版本的单点登录。