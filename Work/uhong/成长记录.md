# 数据库表设计

- 根据加盟商消费赠送体验额度

> 方案一

历史计算、剩余额度、临时变更

消费额度管理

| key          | desc                         |
| ------------ | ---------------------------- |
| user_id      | 加盟商id                     |
| sumMoney     | 消费总金额                   |
| historyMoney | 上次计算时的消费总金额       |
| usedMoney    | 上次计算处理过的金额         |
| leftMoney    | 上次计算时剩余暂不处理的金额 |
| currentMoney | 上次计算后新产生的金额       |

计算赠送处理记录

| key        | Desc       |
| ---------- | ---------- |
| perMoney   | 优惠价     |
| perQuota   | 优惠名额数 |
| updateTime | 变更时间   |

> 更优方案

give_quota

| key                  | type |      | desc |
| -------------------- | ---- | ---- | ---- |
| id                   |      |      |      |
| user_id              |      |      |      |
| total_money          |      |      |      |
| last_remaining_money |      |      |      |
| new_money            |      |      |      |
| used_money           |      |      |      |
| quota_numbers        |      |      |      |
| remain_monry         |      |      |      |
| create_time          |      |      |      |

# 数据库查询





# 接口变更



- 查询试卷

旧接口

```python
data = Struct()
if request.method == "GET":
    id = int(request.GET.get('id'))
    paper = Paper.objects.filter(pk=id).last()
    data.id = paper.id
    data.name = paper.name
    data.remark = paper.remark
    data.assess_type = paper.assess_type
    data.pass_percent = paper.pass_percent
    data.audit_req = paper.audit_req
    data.assess_limit = paper.assess_limit
    data.assess_time = paper.assess_time
    add_user = User.objects.filter(pk=paper.add_user_id).last()
    data.add_user_name = add_user.name if add_user else ""
    data.add_time = paper.add_time.strftime("%Y-%m-%d %H:%M:%S")
    update_user = User.objects.filter(pk=paper.update_user_id).last()
    data.update_user_name = update_user.name if update_user else ""
    data.update_time = paper.update_time.strftime("%Y-%m-%d %H:%M:%S")
    data.group_info = []
    paper_groups = PaperGroup.objects.filter(paper__id=data.id, status=1)
    if paper_groups:
        for pg in paper_groups:
            p = dict(group_id=pg.id, group_name=pg.name, sequence=pg.sequence, catalogs=[])
            pgc = PaperGroupCatalogRelation.objects.filter(paper_group__id=p["group_id"], status=1)
            if pgc:
                for ct in pgc:
                    cts = Catalog.objects.filter(pk=ct.catalog_id, status=1).last()
                    if cts:
                        c_name = cts.name if cts else ''
                        points = SystemTestPoint.objects.filter(catalog__id=ct.catalog_id, status=1)
                        p_num = points.count() if points else 0
                        p_min_q_num = min(
                            [SystemTest.objects.filter(catalog__id=ct.catalog_id, point=o.id, status=1).count()
                             for o in points]) if points else 0
                        c = dict(catalog_id=ct.catalog_id, catalog_name=c_name, q_num=ct.q_num, q_score=ct.q_score,
                                 point_num=p_num, point_min_q_num=p_min_q_num)
                        p["catalogs"].append(c)
            data.group_info.append(p)
    return ajax_ok(data)
else:
    return ajax_fail(message="请求方式错误")
```

新接口

```python
data = Struct()
if request.method == "GET":
    id = int(request.GET.get('id'))
    paper = Paper.objects.filter(pk=id).last()
    if not paper:
        return ajax_fail("此试卷不存在")
    data.id = paper.id
    data.name = paper.name
    data.remark = paper.remark
    data.assess_type = paper.assess_type
    data.pass_percent = paper.pass_percent
    data.audit_req = paper.audit_req
    data.assess_limit = paper.assess_limit
    data.assess_time = paper.assess_time
    add_user = User.objects.filter(pk=paper.add_user_id).last()
    data.add_user_name = add_user.name if add_user else ""
    data.add_time = paper.add_time.strftime("%Y-%m-%d %H:%M:%S")
    update_user = User.objects.filter(pk=paper.update_user_id).last()
    data.update_user_name = update_user.name if update_user else ""
    data.update_time = paper.update_time.strftime("%Y-%m-%d %H:%M:%S")
    data.group_info = []
    paper_groups = PaperGroup.objects.filter(paper__id=data.id, status=1).values('id', 'name').order_by("sequence")
    pgc = PaperGroupCatalogRelation.objects.filter(paper_group_id__in=[pg['id'] for pg in paper_groups], status=1).\
        values('catalog_id', 'paper_group_id', 'q_num', 'q_score').order_by('sequence')
    pgc_dict = {p['catalog_id']: p for p in pgc}
    catalog_ids = [p['catalog_id'] for p in pgc]
    res = get_catalogs_point_num(catalog_ids)
    catalogs = Catalog.objects.filter(pk__in=catalog_ids).values('id', 'name')
    catalog_dict = {c['id']: c['name'] for c in catalogs}
    for pg in paper_groups:  # 试卷分组信息
        p = dict(group_id=pg['id'], group_name=pg['name'], catalogs=[])
        catalog_ids = [p['catalog_id'] for p in pgc if p['paper_group_id'] == pg['id']]
        for id in catalog_ids:
            row = Struct()
            row.catalog_id = id
            row.catalog_name = catalog_dict.get(id)
            row.q_num = pgc_dict.get(id)['q_num']
            row.q_score = pgc_dict.get(id)['q_score']
            row.point_num = res.get(id)['point_num']
            row.point_min_q_num = res.get(id)['point_min_q_num']
            p['catalogs'].append(row)
        data.group_info.append(p)
    return ajax_ok(data)
else:
    return ajax_fail(message="请求方式错误")


def get_catalogs_point_num(catalog_ids):
    result = {}
    if not catalog_ids:
        return result

    sql = """select a.catalog_id, count(a.point_id) as point_num, min(a.q_num) as point_min_q_num  from (
                select c.id as catalog_id, p.id as point_id, count(t.id) as q_num from train_catalog c 
                left join test_point p on c.id=p.catalog_id and p.status=1
                left join train_system_test t on t.point_id=p.id and t.status=1
                where c.id in %(catalog_ids)s
                group by c.id, p.id
            ) a
            group by a.catalog_id"""
    params = dict(catalog_ids=catalog_ids)
    catalog_list = db.fetchall_to_dict((sql, params), 'ziyuan_px')
    result = {c['catalog_id']: c for c in catalog_list}
    return result
```

