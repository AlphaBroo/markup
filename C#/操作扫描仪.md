# 操作扫描仪

C#中连接扫描仪，大概有如下方法

```
WIA
Kodak控件
TWAIN
```

## WIA

WIA（Windows Image Acquire，最新版本2.0）是Windows中一组从设备中捕获图像的标准API集合，它可以从设备（例如扫描仪、数码相机）中获取静态图像，以及管理这些设备。它既是API，又是DDI（Device Driver Interface）。因此，只要是满足这个规范的设备，都能够利用WIA直接和应用程序交互，而不是通过驱动。WIA甚至提供了统一的对话框来获取图片。

WIA是基于Com的，有两种使用方式：

1. c++：使用WIA自定义接口
2. 其他：使用WIAAL（WIA Automation Layer）。

注：在Windows XP sp1以前的版本，WIAAL还不存在，因此第二种方式用的是WIA Scripting Model。

在.Net中使用WIA，我们用的是第二种方法。

### 简单扫描

- 界面

新建一个WinForm应用程序，在上面添加一个按钮和一个图片框，点击按钮时启动扫描进程，然后在图片框中显示图像

- 引入wia

在VS中添加wai引用

引用命名空间

```
using WIA
```

- 连接扫描仪

```c#
Device device = null;
foreach (DeviceInfo info in manager.DeviceInfos)
{
    if (info.Type != WiaDeviceType.ScannerDeviceType) continue;
    device = info.Connect();
    break;
}
```

- 打开扫描对话框

在button的Click事件中，添加

```C#
ImageFile imageFile = null;
CommonDialogClass cdc = new WIA.CommonDialogClass();

try
{
    imageFile = cdc.ShowAcquireImage(WIA.WiaDeviceType.ScannerDeviceType,
                     WIA.WiaImageIntent.TextIntent,
                     WIA.WiaImageBias.MaximizeQuality,
                     "{00000000-0000-0000-0000-000000000000}",
                     true,
                     true,
                     false);
}
catch (System.Runtime.InteropServices.COMException)
{
    imageFile = null;
}
```

- 显示扫描过程

```c#
CommonDialogClass cdc = new WIA.CommonDialogClass();
ImageFile imageFile = cdc.ShowTransfer(item,
    "{B96B3CAB-0728-11D3-9D7B-0000F81EF32E}",
    true) as ImageFile;
if (imageFile != null)
{
    var buffer = imageFile.FileData.get_BinaryData() as byte[];
    using (MemoryStream ms = new MemoryStream())
    {
        ms.Write(buffer, 0, buffer.Length);
        pictureBox1.Image = Image.FromStream(ms);
    }
}
```

- 获取图像

调用ShowAcquireImage后，扫描后的数据就保存在ImageFile对象里了。用以下方法读取ImageFile中的数据（该方法很傻很傻……很傻）

```c#
if (imageFile != null)
{

    imageFile.SaveFile(@"c:\1.bmp");
    using (FileStream stream = new FileStream(@"c:\1.bmp", FileMode.Open,
        FileAccess.Read, FileShare.Read))
    {
        pictureBox1.Image = Image.FromStream(stream);
    }    File.Delete(@"c:\1.bmp");
}
```

- 把扫描得到的图片顺时针旋转90度

```c#
if (imageFile != null)
{

    ImageProcess ip = new ImageProcessClass();

    object filterName="RotateFlip";
    Object propertyName = "RotationAngle";
    Object propertyValue = 90;

    ip.Filters.Add(ip.FilterInfos.get_Item(ref filterName).FilterID, 0);
    ip.Filters[1].Properties.get_Item(ref propertyName).set_Value(ref propertyValue);

    var buffer =ip.Apply(imageFile).FileData.get_BinaryData() as byte[];
    using (MemoryStream ms = new MemoryStream())
    {
        ms.Write(buffer, 0, buffer.Length);
        pictureBox1.Image = Image.FromStream(ms);
    }

}
```

- 完整参考

参考一

```c#
 		try
            {
                DeviceManager manager = new DeviceManagerClass();
                Device device = null;
                foreach (DeviceInfo info in manager.DeviceInfos)
                {
                    if (info.Type != WiaDeviceType.ScannerDeviceType)
                        continue;
                    device = info.Connect();
                    break;
                }
                Item item = device.Items[1];
                CommonDialogClass cdc = new WIA.CommonDialogClass();
                imageFile = cdc.ShowAcquireImage(
                    WIA.WiaDeviceType.ScannerDeviceType,
					WIA.WiaImageIntent.TextIntent,
                    WIA.WiaImageBias.MaximizeQuality, 
                    "{00000000-0000-0000-0000-000000000000}", 
                    true, true, false);
                /*imageFile = cdc.ShowAcquireImage(
                	WIA.WiaDeviceType.ScannerDeviceType,
					WIA.WiaImageIntent.TextIntent,
                    WIA.WiaImageBias.MaximizeQuality, 
                    "{B96B3CB0-0728-11D3-9D7B-0000F81EF32E}", 
                    true, true, false);*/
                if (imageFile != null)
                {
                    var buffer = imageFile.FileData.get_BinaryData() as byte[];
                    using (MemoryStream ms = new MemoryStream())
                    {
                        ms.Write(buffer, 0, buffer.Length);
                        try
                        {
                            SealPicture.Image = Image.FromStream(ms);
                        }
                        catch { }
                    }
                }
                //ImageBuild();
            }
            catch
            {
                MessageBox.Show(
                    "请检查扫描仪是否连接正确！", 
                    "提示...", 
                    MessageBoxButtons.OK,
					MessageBoxIcon.Stop
                );
            }
```

参考二

```c#
		private ImageFile imageFile = null;
        private string ScanTemp = ConfigurationSettings.AppSettings["ScanTemp"].ToString().Trim();
        private string imgType = "jpg";
        private DeviceManager manager = null;
        private Device device = null;
        private List<System.Drawing.Image> imgs = new List<System.Drawing.Image>();

        private List<System.Drawing.Image> StartScan()
        {
            manager = new DeviceManagerClass();
           
            foreach( DeviceInfo info in manager.DeviceInfos )
            {
                if( info.Type != WiaDeviceType.ScannerDeviceType ) continue;
                device = info.Connect();
                break;
            }

            if( device == null )
            {
                throw new Exception("扫描仪没连接！");
            }

            Item item = device.Items[1];
            CommonDialogClass cdc = new WIA.CommonDialogClass();
            //string formatID = this.GetWiaFormat();
            try
            {
                imageFile = cdc.ShowAcquireImage( WiaDeviceType.ScannerDeviceType, WiaImageIntent.UnspecifiedIntent,
                                                 WiaImageBias.MinimizeSize, "{B96B3CAB-0728-11D3-9D7B-0000F81EF32E}", true, false, false );
                
            }
            catch( System.Runtime.InteropServices.COMException ex)
            {
                imageFile = null;
                //throw new Exception( ex.Message );
            }

            while( imageFile != null )
            {
                var buffer = imageFile.FileData.get_BinaryData() as byte[];
                using( MemoryStream ms = new MemoryStream() )
                {
                    ms.Write( buffer, 0, buffer.Length );
                    imgs.Add( System.Drawing.Image.FromStream( ms ) );
                }
                imageFile = null;

                try
                {
                    imageFile = cdc.ShowTransfer( item, "{B96B3CAB-0728-11D3-9D7B-0000F81EF32E}", false ) as ImageFile;
                }
                catch( Exception ex )
                {
                    return imgs;
                    //throw new Exception( ex.Message );                    
                }          
            }
            return imgs;
        }
```

### 批量扫描

```c#
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;

using WIA;
using System.IO;
using System.Drawing.Imaging;
using iTextSharp;
using iTextSharp.text;
using iTextSharp.text.pdf;
using System.Drawing.Drawing2D;

namespace printTest
{

    public partial class Form1 : Form
    {


        List<System.Drawing.Image> images = new List<System.Drawing.Image>();
        public static List<string> GetDevices()
        {
            List<string> devices = new List<string>();
            WIA.DeviceManager manager = new WIA.DeviceManager();
            foreach (WIA.DeviceInfo info in manager.DeviceInfos)
            {
                devices.Add(info.DeviceID);
            }
            return devices;
        }


        const string wiaFormatBMP = "{B96B3CAB-0728-11D3-9D7B-0000F81EF32E}";
        class WIA_DPS_DOCUMENT_HANDLING_SELECT
        {
            public const uint FEEDER = 0x00000001;
            public const uint FLATBED = 0x00000002;
        }
        class WIA_DPS_DOCUMENT_HANDLING_STATUS
        {
            public const uint FEED_READY = 0x00000001;
        }
        class WIA_PROPERTIES
        {
            public const uint WIA_RESERVED_FOR_NEW_PROPS = 1024;
            public const uint WIA_DIP_FIRST = 2;
            public const uint WIA_DPA_FIRST = WIA_DIP_FIRST + WIA_RESERVED_FOR_NEW_PROPS;
            public const uint WIA_DPC_FIRST = WIA_DPA_FIRST + WIA_RESERVED_FOR_NEW_PROPS;
            //
            // Scanner only device properties (DPS)
            //
            public const uint WIA_DPS_FIRST = WIA_DPC_FIRST + WIA_RESERVED_FOR_NEW_PROPS;
            public const uint WIA_DPS_DOCUMENT_HANDLING_STATUS = WIA_DPS_FIRST + 13;
            public const uint WIA_DPS_DOCUMENT_HANDLING_SELECT = WIA_DPS_FIRST + 14;
        }

        #region 画矩形使用到的变量
        Point p1;   //定义鼠标按下时的坐标点
        Point p2;   //定义移动鼠标时的坐标点
        Point p3;   //定义松开鼠标时的坐标点
        #endregion

        #region 缩放、裁剪图像用到的变量
        /// <summary>
        /// 
        /// </summary>
        int x1;     //鼠标按下时横坐标
        int y1;     //鼠标按下时纵坐标
        int width;  //所打开的图像的宽
        int heigth; //所打开的图像的高
        bool HeadImageBool = false;    // 此布尔变量用来判断pictureBox1控件是否有图片
        #endregion
        Bitmap Bi;  //定义位图对像
        public Form1()
        {
            InitializeComponent();
        }

        #region 扫描1
        private void btnScan_Click(object sender, EventArgs e)
        {

            listBox1.Items.Clear();
            lbDevices.Items.Clear();
            List<string> devices = GetDevices();

            foreach (string device in devices)
            {
                lbDevices.Items.Add(device);
            }
            //check if device is not available
            if (lbDevices.Items.Count == 0)
            {
                MessageBox.Show("没有任何可用的打印、扫描设备！");
                this.Close();
            }
            else
            {
                lbDevices.SelectedIndex = 0;
            }


            bool hasMorePages = true;
            string deviceID = (string)lbDevices.SelectedItem;
            while (hasMorePages)
            {
                //select the correct scanner using the provided scannerId parameter
                WIA.DeviceManager manager = new WIA.DeviceManager();
                WIA.Device device = null;
                foreach (WIA.DeviceInfo info in manager.DeviceInfos)
                {
                    if (info.DeviceID == deviceID)
                    {
                        // connect to scanner
                        device = info.Connect();
                        break;
                    }
                }
                // device was not found
                if (device == null)
                {
                    // enumerate available devices
                    string availableDevices = "";
                    foreach (WIA.DeviceInfo info in manager.DeviceInfos)
                    {
                        availableDevices += info.DeviceID + "\n";
                    }

                    // show error with available devices
                    throw new Exception("The device with provided ID could not be found. Available Devices:\n" + availableDevices);
                }
                int i = device.Items.Count;
                WIA.Item item = device.Items[1] as WIA.Item;

                try
                {
                    // scan image
                    WIA.ICommonDialog wiaCommonDialog = new WIA.CommonDialog();
                    WIA.ImageFile image = (WIA.ImageFile)wiaCommonDialog.ShowTransfer(item, wiaFormatBMP, false);

                    // save to temp file
                    string fileName = Path.GetTempFileName();
                    File.Delete(fileName);
                    image.SaveFile(fileName);//保存temp文件
                    image = null;
                    int leng = @"C:\Users\ll\AppData\Local\Temp".Length;
                    // add file to output list
                    listBox1.Items.Add(fileName.Substring(leng, fileName.Length - leng));
                    //listBox1.Items.Add(fileName);
                    images.Add(System.Drawing.Image.FromFile(fileName));//C:\Users\ll\AppData\Local\Temp
                }
                catch (Exception exc)
                {
                    //MessageBox.Show(exc.Message);
                }
                finally
                {
                    item = null;
                    //determine if there are any more pages waiting
                    WIA.Property documentHandlingSelect = null;
                    WIA.Property documentHandlingStatus = null;
                    foreach (WIA.Property prop in device.Properties)
                    {
                        if (prop.PropertyID == WIA_PROPERTIES.WIA_DPS_DOCUMENT_HANDLING_SELECT)
                            documentHandlingSelect = prop;
                        if (prop.PropertyID == WIA_PROPERTIES.WIA_DPS_DOCUMENT_HANDLING_STATUS)
                            documentHandlingStatus = prop;
                    }

                    // assume there are no more pages
                    hasMorePages = false;

                    // may not exist on flatbed scanner but required for feeder
                    if (documentHandlingSelect != null)
                    {
                        // check for document feeder
                        if ((Convert.ToUInt32(documentHandlingSelect.get_Value()) & WIA_DPS_DOCUMENT_HANDLING_SELECT.FEEDER) != 0)
                        {
                            hasMorePages = ((Convert.ToUInt32(documentHandlingStatus.get_Value()) & WIA_DPS_DOCUMENT_HANDLING_STATUS.FEED_READY) != 0);
                        }
                    }
                }
            }
            if (images.Count >= 0)
            {
                pictureBox1.Image = images[0];
                double imageX = pictureBox1.Image.Width;
                double imageY = pictureBox1.Image.Height;

                double picX = pictureBox1.Width;
                double pixY = pictureBox1.Height;

                //pictureBox2.Image = images[0];
                //pictureBox1.SizeMode = System.Windows.Forms.PictureBoxSizeMode.Zoom;
            }
        } 
        #endregion

        #region 保存
        private void button1_Click(object sender, EventArgs e)
        {
            if (pictureBox2.Image != null)
            {
                string where = @"E:\" + DateTime.Now.ToString("yyyy-MM-dd HHmmss");
                //save scanned image into specific folder
                pictureBox2.Image.Save(where + ".jpeg", ImageFormat.Jpeg);

        //        //iTextSharp.text.Rectangle pageSize = new iTextSharp.text.Rectangle(216f, 716f);
        //        iTextSharp.text.Rectangle pageSize = new iTextSharp.text.Rectangle(216f, 716f);
        //        pageSize.BackgroundColor = new iTextSharp.text.BaseColor(0xFF, 0xFF, 0xDE);
        //        iTextSharp.text.Image img1 = iTextSharp.text.Image.GetInstance(pictureBox1.Image, iTextSharp.text.BaseColor.WHITE);
        //        //设置边界
        //        //Document document = new Document(pageSize, 36f, 72f, 108f, 180f);
        //        Document document = new Document(pageSize, 36f, 72f, 108f, 180f);
        //        PdfWriter.GetInstance(document, new FileStream(where + ".pdf", FileMode.Create));
        //        // 添加文档信息
        //        document.AddTitle("PDFInfo");
        //        document.AddSubject("Demo of PDFInfo");
        //        document.AddKeywords("Info, PDF, Demo");
        //        document.AddCreator("SetPdfInfoDemo");
        //        document.AddAuthor("zeda");
        //        document.Open();
        //        // 添加文档内容
        //        document.Add(img1);
        //        document.Close();
            }
        } 
        #endregion

        #region 顺时针旋转
        private void button4_Click(object sender, EventArgs e)
        {
            if (pictureBox1.Image != null)
            {
                try
                {
                    Bitmap a = new Bitmap(pictureBox1.Image);//得到图片框中的图片
                    pictureBox1.Image = Rotate(a, 90);
                    //pictureBox1.SizeMode = PictureBoxSizeMode.AutoSize;
                    pictureBox1.Location = panel1.Location;
                    pictureBox1.Refresh();//最后刷新图片框
                }
                catch { }
            }
        }
        #endregion

        #region 扫描4
        private void button5_Click(object sender, EventArgs e)
        {
            ImageFile imageFile = null;
            CommonDialogClass cdc = new WIA.CommonDialogClass();

            try
            {
                imageFile = cdc.ShowAcquireImage(WIA.WiaDeviceType.ScannerDeviceType,
                                                 WIA.WiaImageIntent.TextIntent,
                                                 WIA.WiaImageBias.MaximizeQuality,
                                                 "{00000000-0000-0000-0000-000000000000}",
                                                 true,
                                                 true,
                                                 false);

                string fileName = Path.GetTempFileName();
                File.Delete(fileName);
                if (imageFile != null)
                {
                    imageFile.SaveFile(fileName);//保存temp文件
                    imageFile = null;
                    int leng = @"C:\Users\ll\AppData\Local\Temp".Length;
                    // add file to output list
                    listBox1.Items.Add(fileName.Substring(leng, fileName.Length - leng));
                    //listBox1.Items.Add(fileName);
                    images.Add(System.Drawing.Image.FromFile(fileName));//C:\Users\ll\AppData\Local\Temp
                    foreach (System.Drawing.Image im in images)
                    {
                        string where = @"E:\" + DateTime.Now.ToString("yyyy-MM-dd HHmmss");
                        //save scanned image into specific folder
                        im.Save(where + ".jpeg", ImageFormat.Jpeg);
                    }
                }
            }
            catch (System.Runtime.InteropServices.COMException)
            {
                imageFile = null;
            }
        }
        #endregion
        int i = 0;
        #region 增加
        private void button2_Click(object sender, EventArgs e)
        {
            i++;
            label1.Text = i.ToString();
            if (i < images.Count && i >= 0)
            {
                pictureBox1.Image = images[i];
                //pictureBox2.Image = images[i];
                //pictureBox1.SizeMode = System.Windows.Forms.PictureBoxSizeMode.Zoom;
            }
        } 
        #endregion

        #region 减小
        private void button3_Click(object sender, EventArgs e)
        {
            i--;
            label1.Text = i.ToString();
            if (i < images.Count && i >= 0)
            {
                pictureBox1.Image = images[i];
                //pictureBox2.Image = images[i];
                //pictureBox1.SizeMode = System.Windows.Forms.PictureBoxSizeMode.Zoom;
            }
        } 
        #endregion

        #region 旋转
        private void button6_Click(object sender, EventArgs e)
        {
            if (pictureBox1.Image != null)
            {
                try
                {
                    Bitmap a = new Bitmap(pictureBox1.Image);//得到图片框中的图片
                    pictureBox1.Image = Rotate(a, -90);
                    //pictureBox1.SizeMode = PictureBoxSizeMode.AutoSize;
                    pictureBox1.Location = panel1.Location;
                    pictureBox1.Refresh();//最后刷新图片框
                }
                catch { }
            }
        } 
        #endregion


        #region 图片旋转函数
        /// <summary>
        /// 以逆时针为方向对图像进行旋转
        /// </summary>
        /// <param name="b">位图流</param>
        /// <param name="angle">旋转角度[0,360](前台给的)</param>
        /// <returns></returns>
        public Bitmap Rotate(Bitmap b, int angle)
        {
            angle = angle % 360;
 
            //弧度转换
            double radian = angle * Math.PI / 180.0;
            double cos = Math.Cos(radian);
            double sin = Math.Sin(radian);
 
            //原图的宽和高
            int w = b.Width;
            int h = b.Height;
            int W = (int)(Math.Max(Math.Abs(w * cos - h * sin), Math.Abs(w * cos + h * sin)));
            int H = (int)(Math.Max(Math.Abs(w * sin - h * cos), Math.Abs(w * sin + h * cos)));
 
            //目标位图
            Bitmap dsImage = new Bitmap(W, H);
            Graphics g = Graphics.FromImage(dsImage);            
 
            g.InterpolationMode = InterpolationMode.Bilinear;
 
            g.SmoothingMode = SmoothingMode.HighQuality;
 
            //计算偏移量
            Point Offset = new Point((W - w) / 2, (H - h) / 2);
 
            //构造图像显示区域：让图像的中心与窗口的中心点一致
             System.Drawing.Rectangle rect = new  System.Drawing.Rectangle(Offset.X, Offset.Y, w, h);
            Point center = new Point(rect.X + rect.Width / 2, rect.Y + rect.Height / 2);
            g.TranslateTransform(center.X, center.Y);
            g.RotateTransform(360 - angle);
 
            //恢复图像在水平和垂直方向的平移
            g.TranslateTransform(-center.X, -center.Y);
            g.DrawImage(b, rect);
 
            //重至绘图的所有变换
            g.ResetTransform();
 
            g.Save();
            g.Dispose();
            return dsImage;
        }
        #endregion 图片旋转函数更多 0

        private void Form1_Load(object sender, EventArgs e)
        {
            #region 滚动条
            panel2.AutoScroll = true;
            pictureBox1.SizeMode = System.Windows.Forms.PictureBoxSizeMode.AutoSize;

            panel3.AutoScroll = true;
            pictureBox1.SizeMode = System.Windows.Forms.PictureBoxSizeMode.AutoSize; 

            #endregion


            #region 自动缩放
            //pictureBox1.SizeMode = System.Windows.Forms.PictureBoxSizeMode.Zoom;
            //pictureBox1.Dock = System.Windows.Forms.DockStyle.Fill;


            //pictureBox2.SizeMode = System.Windows.Forms.PictureBoxSizeMode.Zoom;
            //pictureBox2.Dock = System.Windows.Forms.DockStyle.Fill; 
            #endregion
        }

        private void pictureBox1_MouseDown(object sender, MouseEventArgs e)
        {
            this.Cursor = Cursors.Cross;
            this.p1 = new Point(e.X, e.Y);
            x1 = e.X;
            y1 = e.Y;
            if (this.pictureBox1.Image != null)
            {
                HeadImageBool = true;
            }
            else
            {
                HeadImageBool = false;
            }
        }

        #region 移动鼠标发生的事件
        /// <summary>
        /// 鼠标移动事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void pictureBox1_MouseMove(object sender, MouseEventArgs e)
        {
            if (this.Cursor == Cursors.Cross)
            {
                this.p2 = new Point(e.X, e.Y);
                if ((p2.X - p1.X) > 0 && (p2.Y - p1.Y) > 0)     //当鼠标从左上角向开始移动时P3坐标
                {
                    this.p3 = new Point(p1.X, p1.Y);
                }
                if ((p2.X - p1.X) < 0 && (p2.Y - p1.Y) > 0)     //当鼠标从右上角向左下方向开始移动时P3坐标
                {
                    this.p3 = new Point(p2.X, p1.Y);
                }
                if ((p2.X - p1.X) > 0 && (p2.Y - p1.Y) < 0)     //当鼠标从左下角向上开始移动时P3坐标
                {
                    this.p3 = new Point(p1.X, p2.Y);
                }
                if ((p2.X - p1.X) < 0 && (p2.Y - p1.Y) < 0)     //当鼠标从右下角向左方向上开始移动时P3坐标
                {
                    this.p3 = new Point(p2.X, p2.Y);
                }
                this.pictureBox1.Invalidate();  //使控件的整个图面无效,并导致重绘控件
            }
        }
        #endregion


        #region 松开鼠标发生的事件,实例化ImageCut1类对像
        ImageCut1 IC1;  //定义所画矩形的图像对像
        /// <summary>
        /// 鼠标放开事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void pictureBox1_MouseUp(object sender, MouseEventArgs e)
        {
            if (HeadImageBool)
            {
                width = this.pictureBox1.Image.Width;
                heigth = this.pictureBox1.Image.Height;
                if ((e.X - x1) > 0 && (e.Y - y1) > 0)   //当鼠标从左上角向右下方向开始移动时发生
                {
                    IC1 = new ImageCut1(x1, y1, Math.Abs(e.X - x1), Math.Abs(e.Y - y1));    //实例化ImageCut1类
                }
                if ((e.X - x1) < 0 && (e.Y - y1) > 0)   //当鼠标从右上角向左下方向开始移动时发生
                {
                    IC1 = new ImageCut1(e.X, y1, Math.Abs(e.X - x1), Math.Abs(e.Y - y1));   //实例化ImageCut1类
                }
                if ((e.X - x1) > 0 && (e.Y - y1) < 0)   //当鼠标从左下角向右上方向开始移动时发生
                {
                    IC1 = new ImageCut1(x1, e.Y, Math.Abs(e.X - x1), Math.Abs(e.Y - y1));   //实例化ImageCut1类
                }
                if ((e.X - x1) < 0 && (e.Y - y1) < 0)   //当鼠标从右下角向左上方向开始移动时发生
                {
                    IC1 = new ImageCut1(e.X, e.Y, Math.Abs(e.X - x1), Math.Abs(e.Y - y1));      //实例化ImageCut1类
                }

                if (IC1 != null)
                {
                    this.pictureBox2.Width = (IC1.KiCut1((Bitmap)(this.pictureBox1.Image))).Width;
                    this.pictureBox2.Height = (IC1.KiCut1((Bitmap)(this.pictureBox1.Image))).Height;
                    this.pictureBox2.Image = IC1.KiCut1((Bitmap)(this.pictureBox1.Image));

                    //this.pictureBox2.Image = IC1.KiCut1((Bitmap)(this.pictureBox1.Image));
                    //boolShow1 = true;
                    //else if (pictureBox3.Image == null)
                    //{
                    //    this.pictureBox3.Image = IC1.KiCut1((Bitmap)(this.pictureBox1.Image));
                    //    boolShow2 = true;
                    //}
                    //else
                    //{
                    //    if (boolShow2 == true)
                    //    {
                    //        this.pictureBox2.Image = IC1.KiCut1((Bitmap)(this.pictureBox1.Image));
                    //        boolShow1 = true;
                    //        boolShow2 = false;
                    //    }
                    //    else
                    //    {
                    //        this.pictureBox3.Image = IC1.KiCut1((Bitmap)(this.pictureBox1.Image));
                    //        boolShow1 = false;
                    //        boolShow2 = true;
                    //    }
                    //}
                }
                this.Cursor = Cursors.Default;
            }
            else
            {
                this.Cursor = Cursors.Default;
            }
        }
        #endregion


        #region 重新绘制pictureBox1控件，即移动鼠标画矩形
        private void pictureBox1_Paint(object sender, PaintEventArgs e)
        {
            if (HeadImageBool)
            {
                Pen p = new Pen(Color.Black, 1);//画笔
                p.DashStyle = System.Drawing.Drawing2D.DashStyle.Dash;
                //Bitmap bitmap = new Bitmap(strHeadImagePath);
                Bitmap bitmap = Bi;
                System.Drawing.Rectangle rect = new System.Drawing.Rectangle(p3, new Size(System.Math.Abs(p2.X - p1.X), System.Math.Abs(p2.Y - p1.Y)));
                e.Graphics.DrawRectangle(p, rect);

            }
            else
            {
            }
        }
        #endregion

        private void listBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            //string fileName = DateTime.Now.ToString("yyyyMMddhhmmss");
            //string path = Path.GetFullPath("images/");
            //string[] files = Directory.GetFiles(path);
            //foreach (string file in files)
            //{
            //    if (file == path + fileName + ".jpg")
            //    {
            //        return;
            //    }

            //}
            //using (Stream stream = new FileStream(path + fileName + ".jpg", FileMode.Create))
            //{
            //    using (FileStream fs = new FileStream(listBox1.SelectedItem.ToString(), FileMode.Open))
            //    {
            //        byte[] bytes = new byte[1024 * 10];
            //        int len;
            //        while ((len = fs.Read(bytes, 0, bytes.Length)) > 0)
            //        {
            //            stream.Write(bytes, 0, len);

            //        }
            //    }
            //}
            //System.Drawing.Image image = System.Drawing.Image.FromFile(path + fileName + ".jpg");
            //pictureBox1.Image = image;
        }

       
    }
}
```

### 封装类

```c#
using System;
using System.Collections.Generic;
using System.Text;
using WIA;
using System.IO;
using System.Drawing;
using System.Windows.Forms;

namespace WMSclient.Scanner
{//手动扫描
    class Wia_ScanClass
    {
        private class WIA_DPS_DOCUMENT_HANDLING_SELECT
        {
            public const uint FEEDER = 1u;
            public const uint FLATBED = 2u;
        }
        private class WIA_DPS_DOCUMENT_HANDLING_STATUS
        {
            public const uint FEED_READY = 1u;
        }
        private class WIA_PROPERTIES
        {
            public const uint WIA_RESERVED_FOR_NEW_PROPS = 1024u;
            public const uint WIA_DIP_FIRST = 2u;
            public const uint WIA_DPA_FIRST = 1026u;
            public const uint WIA_DPC_FIRST = 2050u;
            public const uint WIA_DPS_FIRST = 3074u;
            public const uint WIA_DPS_DOCUMENT_HANDLING_STATUS = 3087u;
            public const uint WIA_DPS_DOCUMENT_HANDLING_SELECT = 3088u;
        }
        private class WIA_ERRORS
        {
            public const uint BASE_VAL_WIA_ERROR = 2149646336u;
            public const uint WIA_ERROR_PAPER_EMPTY = 2149646339u;
        }
        public class IMAGEFORAT//图片格式
        {
            public const string wiaFormatBMP = "{B96B3CAB-0728-11D3-9D7B-0000F81EF32E}";
            public const string wiaFormatPNG = "{B96B3CAF-0728-11D3-9D7B-0000F81EF32E}";
            public const string wiaFormatGIF = "{B96B3CB0-0728-11D3-9D7B-0000F81EF32E}";
            public const string wiaFormatJPEG = "{B96B3CAE-0728-11D3-9D7B-0000F81EF32E}";
            public const string wiaFormatTIFF = "{B96B3CB1-0728-11D3-9D7B-0000F81EF32E}";
        }
        public class IMAGEATTRIBUTE
        {
            public const string wia_scan_color_mode = "6146"; //颜色模版
            public const string wia_horizontal_scan_resolution_dpi = "6147"; //水平分辨率
            public const string wia_vertical_scan_resolution_dpi = "6148";//垂直分辨率
            public const string wia_horizontal_scan_start_pixel = "6149";//水平像素
            public const string wia_vertical_scan_start_pixel = "6150";//垂直像素
            public const string wia_horizontal_scan_size_pixels = "6151";
            public const string wia_vertical_scan_size_pixels = "6152";
            public const string wia_scan_brightness_percents = "6154";//亮度
            public const string wia_scan_contrast_percents = "6155";//对比度
        }
        public enum ScanColor
        {
            Color = 1,
            Gray,
            BlackWhite = 4
        }
        /// <summary>
        /// 扫描开始
        /// flag=0，手动设置,此时attribute必须为null;
        /// flag=1，默认设置,此时attribute不为空
        /// </summary>
        /// <param name="flag"></param>
        /// <param name="attribute"></param>
        /// <returns></returns>
        public Dictionary<string, Image> BeginScan(int flag, Dictionary<string, int> attribute)
        {
            Dictionary<string, Image> pic = new Dictionary<string, Image>();
            CommonDialogClass commonDialogClass = new CommonDialogClass();
            //选择扫描仪
            Device device = getAndSelectDevice(commonDialogClass);
            if (device != null)
            {
                string deviceID = device.DeviceID;
                WIA.CommonDialog commonDialog = new WIA.CommonDialog();
                DeviceManager deviceManager = new DeviceManagerClass();
                Device device2 = null;
                foreach (DeviceInfo deviceInfo in deviceManager.DeviceInfos)
                {
                    if (deviceInfo.DeviceID == deviceID)
                    {
                        WIA.Properties properties = deviceInfo.Properties;
                        device2 = deviceInfo.Connect();
                        break;
                    }
                }
                try
                {
                    Image image = null;
                    ImageFile imageFile = null;
                    Item item = null;
                    if (device2 != null)
                    {
                        switch (flag)
                        {
                            case 0: item = getHandleAdjustImageFormat(commonDialog, device2); break;
                            case 1: item = getAutoAdjustImageFormat(device2, attribute); break;
                            default: break;
                        }
                        //获取图片信息
                        imageFile = (ImageFile)getImageFile(commonDialog, IMAGEFORAT.wiaFormatJPEG, item);
                        if (imageFile != null)
                        {
                            string fullpath = Path.GetTempFileName();
                            if (fullpath != null && !"".Equals(fullpath))
                            {
                                if (deleteFile(fullpath))
                                {
                                    imageFile.SaveFile(fullpath);
                                    image = Image.FromFile(fullpath);
                                    if (image != null)
                                    {
                                        pic.Add(fullpath, image);
                                    }
                                    else
                                    {
                                        MessageBox.Show("图片转换失败", "提示");
                                        return null;
                                    }
                                }
                                else
                                {
                                    MessageBox.Show("图片删除失败", "提示");
                                    return null;
                                }
                            }
                            else
                            {
                                MessageBox.Show("图片路径获取失败", "提示");
                                return null;
                            }
                        }
                        else
                        {
                            MessageBox.Show("扫描图片获取失败", "提示");
                            return null;
                        }
                    }
                    else
                    {
                        MessageBox.Show("未连接到扫描仪", "提示");
                        return null;
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show(ex.ToString(), "提示");
                }
            }
            return pic;
        }
        /// <summary>
        /// 删除文件
        /// </summary>
        /// <returns></returns>
        public bool deleteFile(string filePath)
        {
            Boolean flag = false;
            if (File.Exists(filePath))
            {
                File.Delete(filePath);
                flag = true;
            }
            return flag;
        }
        /// <summary>
        /// 选择扫描仪
        /// </summary>
        /// <returns></returns>
        public Device getAndSelectDevice(CommonDialogClass commonDialogClass)
        {
            return commonDialogClass.ShowSelectDevice(WiaDeviceType.UnspecifiedDeviceType, false, false);
        }
        /// <summary>
        /// 获取imagefile
        /// </summary>
        /// <returns>ImageFile</returns>
        /// 
        public ImageFile getImageFile(WIA.CommonDialog commonDialog, string imageFrot, Item item)
        {
            return (ImageFile)commonDialog.ShowTransfer(item, IMAGEFORAT.wiaFormatJPEG, false);
        }
        private void setItem(IItem item, object property, object value)
        {
            WIA.Property aProperty = item.Properties.get_Item(ref property);
            aProperty.set_Value(ref value);
        }
        /// <summary>
        /// 自动调整扫描仪图片格式：默认格式，并返回item
        /// </summary>
        /// <returns>Item</returns>
        public Item getAutoAdjustImageFormat(Device device, Dictionary<string, int> attribute)
        {
            Item item = device.Items[1];
            if (item != null)
            {
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_horizontal_scan_resolution_dpi))
                    setItem(item, IMAGEATTRIBUTE.wia_horizontal_scan_resolution_dpi, attribute[IMAGEATTRIBUTE.wia_horizontal_scan_resolution_dpi]);
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_horizontal_scan_size_pixels))
                    setItem(item, IMAGEATTRIBUTE.wia_horizontal_scan_size_pixels, attribute[IMAGEATTRIBUTE.wia_horizontal_scan_size_pixels]);
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_horizontal_scan_start_pixel))
                    setItem(item, IMAGEATTRIBUTE.wia_horizontal_scan_start_pixel, attribute[IMAGEATTRIBUTE.wia_horizontal_scan_start_pixel]);
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_scan_brightness_percents))
                    setItem(item, IMAGEATTRIBUTE.wia_scan_brightness_percents, attribute[IMAGEATTRIBUTE.wia_scan_brightness_percents]);
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_scan_color_mode))
                {
                    if (attribute[IMAGEATTRIBUTE.wia_scan_color_mode] == 1)
                        setItem(item, IMAGEATTRIBUTE.wia_scan_color_mode, ScanColor.Color);
                    if (attribute[IMAGEATTRIBUTE.wia_scan_color_mode] == 2)
                        setItem(item, IMAGEATTRIBUTE.wia_scan_color_mode, ScanColor.Gray);
                    if (attribute[IMAGEATTRIBUTE.wia_scan_color_mode] == 4)
                        setItem(item, IMAGEATTRIBUTE.wia_scan_color_mode, ScanColor.BlackWhite);
                }
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_scan_contrast_percents))
                    setItem(item, IMAGEATTRIBUTE.wia_scan_contrast_percents, attribute[IMAGEATTRIBUTE.wia_scan_contrast_percents]);
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_vertical_scan_resolution_dpi))
                    setItem(item, IMAGEATTRIBUTE.wia_vertical_scan_resolution_dpi, attribute[IMAGEATTRIBUTE.wia_vertical_scan_resolution_dpi]);
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_vertical_scan_size_pixels))
                    setItem(item, IMAGEATTRIBUTE.wia_vertical_scan_size_pixels, attribute[IMAGEATTRIBUTE.wia_vertical_scan_size_pixels]);
                if (attribute.ContainsKey(IMAGEATTRIBUTE.wia_vertical_scan_start_pixel))
                    setItem(item, IMAGEATTRIBUTE.wia_vertical_scan_start_pixel, attribute[IMAGEATTRIBUTE.wia_vertical_scan_start_pixel]);
            }
            return item;
        }
        /// <summary>
        /// 手动调节格式图片并返回item
        /// </summary>
        /// <returns>Item</returns>
        public Item getHandleAdjustImageFormat(WIA.CommonDialog commonDialog, Device device)
        {
            return commonDialog.ShowSelectItems(device, WIA.WiaImageIntent.TextIntent, WIA.WiaImageBias.MinimizeSize, false, true, false)[1];
        }
        /// <summary>
        /// 重新调整图片格式
        /// </summary>
        /// <param name="item"></param>
        /// <param name="commonDialog"></param>
        /// <returns></returns>
        public void AgainAdjustImageFormat(WIA.CommonDialog commonDialog, Item item)
        {
            commonDialog.ShowItemProperties(item, false);
        }

        /// <summary>
        /// 显示图片信息
        /// </summary>
        /// <param name="imageFile"></param>
        /// <param name="commonDialog"></param>
        /// <returns></returns>
        public void ShowImage(WIA.CommonDialog commonDialog, ImageFile imageFile)
        {
            commonDialog.ShowPhotoPrintingWizard(imageFile);
        }

        /// <summary>
        /// ImageFile 转换成string
        /// </summary>
        /// <param name="imageFile"></param>
        /// <returns></returns>
        public string imageFileToString(ImageFile imageFile)
        {
            string imageString = string.Empty;
            //将获取到得图像转为Image
            if (imageFile != null)
            {
                var buffer = imageFile.FileData.get_BinaryData() as byte[];
                MemoryStream ms = new MemoryStream();
                ms.Write(buffer, 0, buffer.Length);
                imageString = Convert.ToBase64String(buffer);
            }
            return imageString;
        }
        public Image imageFileToImage(ImageFile imageFile)
        {
            Image imgReturn = null;
            //将获取到得图像转为Image
            if (imageFile != null)
            {
                var buffer = imageFile.FileData.get_BinaryData() as byte[];
                MemoryStream ms = new MemoryStream();
                ms.Write(buffer, 0, buffer.Length);
                imgReturn = Image.FromStream(ms);
            }
            return imgReturn;
        }
        /// <summary>
        /// Image 转换成string
        /// </summary>
        /// <param name="image"></param>
        /// <returns></returns>
        public string imageToString(Image image)
        {
            string pic = null;
            try
            {
                MemoryStream ms = new MemoryStream();
                //将图片保存成流
                image.Save(ms, System.Drawing.Imaging.ImageFormat.Jpeg);
                byte[] arr = new byte[ms.Length];
                ms.Position = 0;
                ms.Read(arr, 0, (int)ms.Length);
                ms.Close();
                ms.Dispose();
                pic = Convert.ToBase64String(arr);
            }
            catch (Exception)
            {
                return "Fail to change bitmap to string!";
            }
            return pic;
        }
        /// <summary>
        /// 图片另存为
        /// </summary>
        /// <param name="image"></param>
        /// <returns></returns>
        private System.Drawing.Bitmap curBitmap;
        public void SaveAsTo(string curFileName)
        {
            SaveFileDialog saveFileDialog1 = new SaveFileDialog();
            saveFileDialog1.Filter = "BMP文件 (*.bmp) | *.bmp|Gif文件 (*.gif) | *.gif|JPEG文件 (*.jpg) | *.jpg|PNG文件 (*.png) | *.png";
            saveFileDialog1.FilterIndex = 2;
            saveFileDialog1.RestoreDirectory = true;
            saveFileDialog1.Title = "保存为";
            if (saveFileDialog1.ShowDialog() == DialogResult.OK)
            {
                curBitmap = (Bitmap)Image.FromFile(curFileName);
                string fileName = saveFileDialog1.FileName;
                curBitmap.Save(fileName, System.Drawing.Imaging.ImageFormat.Jpeg);
            }
        }
        /// <summary>
        /// 删除临时文件
        /// </summary>
        /// <param name="image"></param>
        /// <param name="path"></param>
        /// <returns></returns>
        public bool deleteTemp(Image image, string path)
        {
            bool result = false;
            if (image != null)
            {
                image.Dispose();
                File.Delete(path);
                result = true;
            }
            return result;
        }
    }
}
```



## kodak

Kodak方法所需要的系统组件： 

```
imgadmin.ocx      imgcmn.dll          imgedit.ocx       imgscan.ocx        xiffr3_0.dll
imgshl.dll        imgthumb.ocx        imm32.dll         jpeg1x32.dll       tifflt.dll
jpeg2x32.dll      oieng400.dll        oiprt400.dll      oislb400.dll       oiui400.dll
oissq400.dll      oitwa400.dll        Run Kodak.bat
```

真正要用到的空间只有两个。不过，在扫描过程中，为了保证图片的编辑以及其他的操作不受影响，建议全部安装，运行Run Kodak.bat注册所有的组件。

 在Kodak的扫描组件中，我们需要的是`imgscan.ocx、imgadmin.ocx、imgedit.ocx`三个为主要的控件，其中`imgscan.ocx`为Kodak的主要扫描组件。

在项目工程中，添加WIA引用以及Kodak组件的应用，Kodak属于工具类，所以在工具箱中还需要添加Kodak组件工具。

使用Kodak扫描，需要拖放Kodak扫描控件到窗口程序中

- 添加Kodak的命名空间：

```
using ScanLibCtl;
```

- 在button时间中的代码

```c#
 SealPicture.Image = null;
 string paths = @"Temp/temp.jpg";
 try
            {
                File.Delete(paths);
            }
            catch { }
            int ll_rtn = axImgScan.OpenScanner(); //打开扫描仪 
            if (ll_rtn == 0)
            {
                if (axImgScan.ScannerAvailable() == true)//判断扫描仪是否可用 
                {
                    axImgScan.MultiPage = true;//是否多页
                    axImgScan.PageCount = axImgScan.PageCount + 1;
                    axImgScan.Image = paths;
                    axImgScan.FileType = FileTypeConstants.JPG_File;//设置文件类型
                    axImgScan.CompressionType = CompressionTypeConstants.JPEG;
                    axImgScan.ScanTo = ScanToConstants.FileOnly;
                    axImgScan.SetPageTypeCompressionOpts(CompPreferenceConstants.GoodDisplay,

ImageTypeConstants.ColorPal4Bit, CompTypeConstants.JPEGCompression,

CompInfoConstants.JPEGHighHigh);//.G31DFaxRBO);
                    axImgScan.StopScanBox = false;
                    axImgScan.ShowSetupBeforeScan = true;//是否在扫描前显示设置界面
                    axImgScan.Show();
                    ll_rtn = axImgScan.StartScan();//开始扫描
                    //以文件流的形式读取图片文件并释放，以便下一次扫面前删除文件
                    try
                    {
                        FileStream Files = new FileStream(paths, FileMode.Open);
                        Image Picture = Image.FromStream(Files);
                        SealPicture.Image = Picture;
                        Files.Close();
                    }
                    catch { }
                    if (ll_rtn == 9254 || ll_rtn == 0) { }
                    else
                    {
                        MessageBox.Show("扫描仪没有正确连接或扫描控件已破坏,请检查!", "系统提

示...", MessageBoxButtons.OK, MessageBoxIcon.Stop);
                    }
                    axImgScan.CloseScanner(); //关闭扫描仪 
                }
                else
                {
                    MessageBox.Show("扫描仪没有正确连接,请重新设置!", "系统提示...",

MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
            }
            else if (ll_rtn == 9219)
            {
                MessageBox.Show("系统没有安装扫描仪或扫描仪没有正确连接！", "系统提示...",

MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
            }
```

- 完整参考

```c#
try
            {
                int k = axImgScan1.ShowSelectScanner();//选择扫描仪
                int ll_rtn = axImgScan1.OpenScanner(); //打开扫描仪 
                if( ll_rtn == 0 )
                {
                    if( axImgScan1.ScannerAvailable() == true )//判断扫描仪是否可用 
                    {
                        //axImgScan1.PageOption = PageOptionConstants.AppendPages;
                        //axImgScan1.PageType = PageTypeConstants.BlackAndWhite;
                        //axImgScan1.PageCount = 0;
                        axImgScan1.MultiPage = true;//是否多页 
                        //axImgScan1.PageCount = axImgScan1.PageCount + 1;
                        string pathGen = ScanTemp + ScanPageName();// @"c:\abc.tif";                        
                        axImgScan1.Image = pathGen;
                        axImgScan1.FileType = FileTypeConstants.TIFF;//设置文件类型 
                        //axImgScan1.GetPageTypeCompressionInfo( ImageTypeConstants.BlackAndWhite1Bit );
                        //axImgScan1.GetPageTypeCompressionType( ImageTypeConstants.BlackAndWhite1Bit ); 

                       // axImgScan1.CompressionType = CompressionTypeConstants.JPEG;
                        axImgScan1.ScanTo = ScanToConstants.FileOnly;//.DisplayAndUseFileTemplate;
                        //axImgScan1.ShowSetupBeforeScan = false;//是否在扫描前显示设置界面
                        axImgScan1.SetPageTypeCompressionOpts( CompPreferenceConstants.CustomSettings, ImageTypeConstants.TrueColor24bitRGB, CompTypeConstants.Uncompressed, CompInfoConstants.NoCompInfo );
                        axImgScan1.StopScanBox = false;
                        axImgScan1.Show();
                        //axImgScan1.GetCompressionPreference() = CompPreferenceConstants.SmallestFile;

                        ll_rtn = axImgScan1.StartScan();//开始扫描

                        if( ll_rtn == 0 )
                        {
                            Byte[] filebyte = GetScanFileByte( axImgScan1.Image );
                            axImgScan1.CloseScanner(); //关闭扫描仪                            
                            //axImgEdit1.Image = axImgScan1.Image;
                            //axImgEdit1.SaveAs( axImgScan1.Image, FileTypeConstants.TIFF, PageTypeConstants.BlackAndWhite, CompressionTypeConstants.NoCompression, CompInfoConstants.NoCompInfo, true );
                        }
                        else
                        {
                            MessageBox.Show( "扫描仪没有正确连接或扫描控件已破坏,请检查!", "系统提示" );
                        }
                        axImgScan1.CloseScanner(); //关闭扫描仪
                    }
                    else
                    {
                        MessageBox.Show( "扫描仪没有正确连接,请重新设置!", "系统提示" );
                    }
                }
                else if( ll_rtn == 9219 )
                {
                    MessageBox.Show( "系统没有安装扫描仪或扫描仪没有正确连接！", "系统提示" );
                }
            }
            catch( Exception ex )
            {
                MessageBox.Show( ex.Message );
            }
```



## TWAIN

demo1

```c#
public ArrayList TransferPictures()
        {
            ArrayList pics = new ArrayList();
            if (srcds.Id == IntPtr.Zero)
                return pics;

            TwRC rc;
            IntPtr hbitmap = IntPtr.Zero;
            TwPendingXfers pxfr = new TwPendingXfers();

            do
            {
                pxfr.Count = 0;
                hbitmap = IntPtr.Zero;

                TwImageInfo iinf = new TwImageInfo();//扫描仪设置的扫描图片信息

                rc = DSiinf(appid, srcds, TwDG.Image, TwDAT.ImageInfo, TwMSG.Get, iinf);//获取扫描图片信息
                if (rc != TwRC.Success)
                {
                    CloseSrc();
                    return pics;
                }


                rc = DSixfer(appid, srcds, TwDG.Image, TwDAT.ImageNativeXfer, TwMSG.Get, ref hbitmap);//扫描程序，如果扫描完成，则返回XferDone
                if (rc != TwRC.XferDone)
                {
                    CloseSrc();
                    return pics;
                }


                rc = DSpxfer(appid, srcds, TwDG.Control, TwDAT.PendingXfers, TwMSG.EndXfer, pxfr);//结束扫描
                if (rc != TwRC.Success)
                {
                    CloseSrc();
                    return pics;
                }

                pics.Add(hbitmap);
            }
            while (pxfr.Count != 0);

            rc = DSpxfer(appid, srcds, TwDG.Control, TwDAT.PendingXfers, TwMSG.Reset, pxfr);
            return pics;
        }
```

- 连续扫描

新建一个ScanCommon类，在调用界面，写下调用扫描的方法

```c#
ScanCommon  scan = new RS_ScanCommon(fileName, this.Handle);
    scan.PassDataBetweenForm += new RS_ScanCommon.PassDataBetweenFormHandler(scan_PassDataBetweenForm);
                 
    //是否连续扫描
    scan.bContinuousScan = true;
    scan.dtRow = dtRow;
    this.Enabled = false;
    scan.StartScan();
```

在ScanCommon类中，调用Twain的接口类（Twain类网络上可以找到，本文略），主要代码如下

```c#
// 添加一个委托 
        public delegate void PassDataBetweenFormHandler(object sender, PassDataEventArgs e);
        // 添加一个PassDataBetweenFormHandler 类型的事件 
        public event PassDataBetweenFormHandler PassDataBetweenForm;

      public ScanCommon(string fileName, IntPtr Handle)
        {
            this.fileName = fileName;
            this.Handle = Handle;

            //扫描初始化（默认使用TWAIN方式进行连接）
            tw = new Twain();
            tw.Init(Handle, out rc);
            //tw.Select();
        }

       //启动扫描
       public void StartScan()
        {
            if (rc != TwRC.Success)
            {
                MessageBox.Show("设备初始化失败，请检查硬件及驱动！");
            }
            else
            {               
                string path = "XXX路径" + "\\ScannerFile\\" + frmName;
                if (Scanning(path) == false)
                {                  
                        MessageBox.Show("设备未找到或设备不支持TWAIN组件，无法自动创建扫描任务。") ;                    
                 
                   //回调主窗口
                    PassDataEventArgs args = new PassDataEventArgs("exit");
                    PassDataBetweenForm(this, args);
                    GC.Collect();
                }
            }
        }
```

在ScanCommon类中，主要的扫描方法均可以通过调用twain类实现，Scanning是调用驱动实现扫描的方法。Application.AddMessageFilter是添加扫描仪的事件监听，在监听事件中返回扫描仪的不同状态以实现取消和扫描的一些操作。

```c#
#region 扫描的一些方法
 private bool Scanning(string filePath)
 {           
     if (!msgfilter)
     {
         msgfilter = true;
         Application.AddMessageFilter(this);
     }
     ScanPath = filePath;
     return tw.Acquire(ref strScanErrorMessage, bContinuousScan);
 }
 
 /// <summary>
 /// 保存图片
 /// </summary>
 /// <param name="dibhandp"></param>
 private void ImageSave(IntPtr dibhandp)
 {
     bmprect = new Rectangle(0, 0, 0, 0);
     if (dibhandp != IntPtr.Zero) dibhand = dibhandp;
     bmpptr = GlobalLock(dibhand);
     pixptr = GetPixelInfo(bmpptr);
 }
 
 public void EndingScan()
 {
     if (msgfilter)
     {
         tw.Finish();
         RemoveMessageFilter(this);
         msgfilter = false;
     }
 }
 
 public static void RemoveMessageFilter(IMessageFilter value)
 {
     Application.RemoveMessageFilter(value);
 }
 #endregion
```

在监听的TwainCommand.TransferReady状态中，是调用扫描仪扫描图片的。我开始的时候尝试修改twain类中TransferPictures的方法，但是结果证实不可行。

其实这是一个误区，我们只需要修改一下twain的启动扫描事件，可以根据是否连续扫描给扫描仪传不同的参数以达到此效果。　

只需一行代码，就可实现一次扫描多张，且不需要更改扫描仪的任何设置。

如果设备支持连续送纸，启动扫描时扫描仪会直接连扫直到纸张全部扫完

```c#
///此行代码是连续扫描
TwCapability cap = new TwCapability(TwCap.XferCount, -1);
```

代码如下

```c#
/// <summary>
/// 启动扫描
/// </summary>
/// <param name="strScanErrorMessage"></param>
/// <returns></returns>       
public bool Acquire(ref string strScanErrorMessage, bool MultiScan)
{
    try
    {
        TwRC rc;
        CloseSrc();
        if (appid.Id == IntPtr.Zero)
        {
            Init(hwnd, out rc);
            if (appid.Id == IntPtr.Zero)
                strScanErrorMessage = "未找到扫描仪设备，请查看是否安装扫描仪驱动！";
            return false;
        }
        rc = DSMident(appid, IntPtr.Zero, TwDG.Control, TwDAT.Identity, TwMSG.OpenDS, srcds);
        if (rc != TwRC.Success)
        {
            strScanErrorMessage = "未找到扫描仪设备";
            return false;
        }
 
        if (MultiScan)
        {
            //如果是连续扫描
            TwCapability cap = new TwCapability(TwCap.XferCount, -1);
            rc = DScap(appid, srcds, TwDG.Control, TwDAT.Capability, TwMSG.Set, cap);
        }
        else
        {
            //否则只扫描一张
            TwCapability cap = new TwCapability(TwCap.XferCount, 1);
            rc = DScap(appid, srcds, TwDG.Control, TwDAT.Capability, TwMSG.Set, cap);
        }
 
        if (rc != TwRC.Success)
        {
            strScanErrorMessage = "未找到扫描仪设备";
            CloseSrc();
            return false;
        }
 
        TwUserInterface guif = new TwUserInterface();
        guif.ShowUI = 1;
        guif.ModalUI = 1;
        guif.ParentHand = hwnd;
        rc = DSuserif(appid, srcds, TwDG.Control, TwDAT.UserInterface, TwMSG.EnableDS, guif);
        if (rc != TwRC.Success)
        {
            strScanErrorMessage = "扫描仪中没有纸";
            CloseSrc();
            GC.Collect();
            return false;
        }
    }
    catch (Exception e)
    {
        strScanErrorMessage = e.Message;
        GC.Collect();
        return false;
    }
    GC.Collect();
    return true;
}
```

扫描结束后，回调主窗口返回数据，主窗口添加如下事件

```c#
private void scan_PassDataBetweenForm(object sender, PassDataEventArgs e)
  {
      if (e.EventStr == "exit")
      {
          this.Cursor = Cursors.WaitCursor;
          frm.dtRow = this.dtRow;
           
          //处理图片的一些方法....
           
          this.Enabled = true;
          this.Cursor = Cursors.Default;
          GC.Collect();
      }
  } 
```

