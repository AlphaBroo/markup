# 简单统计推断

统计推断

```
在总体中按照随机原则抽取一部分单位作为样本，根据样本数据归纳或推断总体数量特征的一种统计方法

基本原理是抽样推断中的大数定理和中心极限定理
```

- 抽样推断分类

参数推断

```
主要是根据抽样分布对总体的特征进行估计和检验，需要事先知道总体的分布状况

分为参数估计和假设检验
```

非参数推断

```
在未知总体分布的情况下，对总体的分布状况进行推断
```

## 原理

### 数据分布

数据分布是描述数据的一种形象方式，可以通过数据分布考察数据中各个数值出现的次数或百分比，描绘了数据出现次数或百分比的变动情况。同时，数据分布通常情况下时针对随机变量而言，也是进行统计推断的基础之一，绝大多数统计推断的结论都是从数据分布开始论述的

- 分类

变量类型划分：离散变量的分布、连续变量的分布

分布形式划分：正态分布、t分布、F分布、${\chi}^2$ (卡方)分布	

研究对象划分：总体分布、样本分布、抽样分布

- 概念

总体分布

```
已知总体往往是一个具有确定分布的随机变量，总体分布就是所有数据的分布
未知总体由于总体分布的参数无从知晓，对其特征腿短则属于非参数统计推断内容
总体分布具体指总体所有变量值的分布状况，即总体变量分布状况的一种概括

总体分布往往时未知的，总体的特征往往也是未知的，通常情况下是假设总体服从一个特定的分布，在这个假设下进行统计分析。总体的特征也叫作总体参数，由于不能完全获得总体数据，所以总体参数往往时未知的，但是总体参数时唯一确定存在的，这是由于当总体一旦确定，总体参数就自然而然确定了

在python中，如不能获得所有总体数据则不能直接计算总体参数，总体的特征只能通过样本数据进行推断
```

样本分布

```
从总体中抽取一个容量为n的分布，其中n叫做样本容量，简称样本量
样本总是在一定总体中抽取的，其中包含总体的一些信息，所以也成为经验分布；随着样本量的增大，样本的分布会逐渐接近总体分布

样本数据易于获得，但是同一个总体可以抽取若干个不同样本，因此，样本之间还是存在差异，这种差异是随机的，可以通过标准误差来衡量。在通常情况下，可以通过样本统计量和样本分布对总体进行推断

在python中，能够根据所获得数据计算样本统计量，病描绘样本分布的情况
```

抽样分布

````
抽样分布指样本统计量的分布

在进行数据的抽样调查中，由于随机性的存在，存在多个不同的样本数据。把这种所有类似情况下获得的所有可能样本找出来，如在总体容量为N的总体中，随机抽取样本容量为n的样本，考虑排列顺序一种可能有N**n,不考虑排列，可获得C_N^n个样本

计算每个样本的统计量，可以得到一系列的统计量数据，这些由统计量组成的数据形成的分布就是抽样分布。

抽样本分提供了样本统计量长远而稳定的信息，是进行推断的理论基础，也是抽样推断科学性的重要依据。由于现实中不能将所有样本都抽取出来，因此抽样分布又是一种理论上的分布
````

由抽样分布特征可以推导出中心极限定理

```
当样本量n充分大(经验法则n>30)的时候，样本值的分布服从以总体均值为均值，以总体方差的1/n倍为方差的正态分布
```

- 误差

在对总体的抽样过程中，由于随机原则的存在，样本和总体总是有差异的，总是不可避免的存在抽样误差。抽样误差具体指所有可能出现的样本指标的标准差，也可以理解为所有样本指标和总体指标之间的平均离差

由于误差的存在，在对样本数据进行分析的过程中，得出的结论就只能是不确定的结论。这个不确定性不代表不正确，而是代表在一定的误差允许范围内，结论的正确性是有概率保证的。

### 参数估计

总体的特征为参数。总体往往未知的，总体特征也往往是未知的，但是总体一旦确定，总体就是确定的，总体参数也是确定且唯一的。

人们可以收集总体的样本数据，利用样本数据计算出来的样本统计量，根据统计推断的基本原则，在一定概率或置信度下对总体参数进行推断。而样本统计量来自于样本数据，样本数据相对于总体数据而言具有多样性和不确定性，但是是已知的。

统计推断的参数估计过程便是利用已知、不确定、不唯一的样本统计量去推断未知、确定、唯一的总体参数的过程，这个过程可以通过利用样本数据对总体特征进行估计的方法实现。

由于估计值和真实值之间存在一定误差，所以参数估计过程一般是在一定的概率或者置信度下做出的。

根据是否有置信度作为保证，分为点估计和区间估计

- 点估计

点估计就是直接用实际抽样的样本数据得到的样本统计量的值，作为总体参数的估计值

点估计是一种不考虑抽样误差问题的估计方法，可以利用矩估计、最大似然估计等方法进行测算

点估计的方法比较简单，但是由于其不考虑抽样误差，可靠性较差，在大样本的时候比较常用。在实际使用中，用于点估计的估计量应当满足无偏、有效、一致性的要求，即估计量的数学期望等于真实值、估计量的方差是所有可用估计量当中最小的、当样本量充分大时估计量趋近于真实值。

- 区间估计

为了提高估计的精度，往往在估计时给出一个可靠程度即置信度。根据置信度的要求，利用随机抽取样本的统计量来确定总体参数估计值的估计上限和估计下限，即根据样本数据确定出总体参数置信区间的方法叫做区间估计

区间估计即在一定的置信度下给出总体参数估计值的一个估计区间，其中置信度是根据抽样误差设置的一种概率保证。置信区间也可理解为在置信度条件下，根据样本统计量和抽样误差去推断总体参数的可能范围。

置信度和置信区间时相关的，在抽象误差和样本量保持不变的条件下，置信度越大，置信区间就越大，置信度越小，置信区间就越小。常用置信度为95%，99%，90%等

### 假设检验

主要研究特定情况下，总体是否具备某种指定的特征。

- 基本原理

在一次观测或试验中几乎不可能发生的事情，称之为小概率事件。小概率事件在一次试验中发生的概率称为显著水平。

假设检验的基本原理是观测小概率事件在假设成立的情况下是否发生。如果在一次试验中小概率事件发生了，说明该假设在一定的显著水平不可靠或不成立，从而否定假设；如果在一次试验中小概率事件没有发生，只能说明没有足够理由相信假设是错误的，但是不能说明假设是正确的，因为在现有条件下无法收集所有的证据去证明它是正确的。

假设检验的结论是在一定的显著性水平下得出的。当我们去观测事件并下结论的时候，是有可能犯错误的。在假设检验过程中，无法保证不犯错误，这些错误主要归纳为如下2类

> 第I类错误

当假设为真的时候却否定它而犯的错误，即拒绝正确假设的错误，也叫弃真错误。犯第I类错误的概率记为$\alpha$,所以通常也叫做$\alpha$错误，$\alpha$=1-置信度。

> 第II类错误

当假设为假时却可定它而犯的错误，即接受错误假设的错误，也叫纳伪错误。犯第II类错误的概率记为$\beta$，所以通常也叫做$\beta$错误。

两类错误在其他条件不变的情况下时相反相成的，即$\alpha$增大时，$\beta$就减小；$\alpha$减小时，$\beta$就增大。要想同时减小两类错误，只能增加样本量。

$\alpha$错误易受分析人员控制，故在假设检验中，人们通常先控制第I类错误发生的概率$\alpha$,具体表现为：在做假设检验之前先指定一个$\alpha$的具体数值，通常取0.05，也可是0.1、0.01等

除了指定理论上的显著水平$\alpha$外，在python的大多数分析工具库中可以根据样本分布和样本数据自动计算出一个实际的显著水平，通常称之为P值，P值也具体指在进行检验过程中实际犯第I类错误的概率

当P值比$\alpha$小的时候，说明实际计算的显著水平比理论的显著水平更小，小概率事件在一次试验中发生的几率更小，人们在P值的显著水平条件下，如果还能够观测到小概率事件的发生，责说明假设更不可靠，可以对假设做出否定的判断；但当P值比$\alpha$值大的时候，在P值的显著水平条件下，如果能够观测得到小概率事件的发生，说明假设可能没有任何问题，因为本来观测一个概率比较大的事件，其发生的可能本来就比较大，不能对假设做出否定的判断。因此，在python中进行假设检验，往往是从P值入手进行判定的，P值越小越能否定原假设。

- 假设检验的基本步骤

统计软件的检验过程与传统手工计算的检验过程有区别。

> 提出假设

没有假设，就没有检验的对象。假设就是对总体特征的一个特定描述。假设可以分为原假设和备择假设。

原假设又称为零假设(null hypothesis)，通常情况下把想要搜集证据去否定的结论作为原假设，用$H_0$表示。而备择假设又可称为研究假设(alternate)，通常情况下把想要搜集证据去支持的结论作为备择假设，用$H_1$表示

原假设和备择假设通常情况下是对立、互斥的。在原假设中的表达式通常包含$=,\ge,\le$等含有等号的符号；而备择假设中通常含有$\ne,\lt,\gt$等含有不等号的符号。

当备择假设含有$\ne$时，称之为双侧或双尾检验，当备择假设含有$\lt,\gt$时，称之为单侧或单尾检验

> 确定$\alpha$

确定理论的显著水平$\alpha$，通常情况下取0.05，也可以取0.1，0.01等。本步骤为手工检验时常用手段，在使用软件工具进行检验时可不知定$\alpha$

> 选择计算统计量

根据已知条件和总体分布状况，在原假设 成立的情况下，选择计算用于检验的统计量。统计量的计算依据检验对象而异，通常情况下对总体均值或总体比例进行检验的统计量计算公式是

```
检验统计量 = (点估计值 - 原假设成立时的参数值) / 点估计值的标准误差
```

> P值判定

在传统的手工检验过程中，这一步通常是根据$\alpha$的大小去查统计量对应的分布表，得到所谓临界值，然后用计算出来的统计量值与临界值对比，若统计量值在临界值之外，表示拒绝原假设，否则没有充分理由拒绝原假设。

在计算机的数据分析工具中，采用如下判定法则对假设检验下结论：

如果$P\le\alpha$，则说明在显著水平$\alpha$条件下，原假设不成立，拒绝原假设，选择备择假设；如果$P\gt\alpha$，说明在显著水平$\alpha$条件下，没有充分证据表明我们应当拒绝原假设。

如果没有制定$\alpha$值，则P值越小越显著。

- 假设检验中总体的几种不同情况

在进行统计推断之前，应该先清楚总体的分布情况，因为不同的总体分布情况下计算的统计量形式不同。检验所用的统计量的形式和步骤取决于所抽取样本的样本量大小，无论大样本还是小样本，此处均假定其总体服从正态分布

> 大样本

根据经验法则，大样本就是指样本量$n\ge30$的样本。以总体均值的假设检验为例，在大样本的情况下，根据中心极限定理，均值的抽样分布服从正态分布，所以可以使用正态统计量(即Z统计量)进行假设检验。

> 小样本

对于小样本(即样本量$n\lt30$的样本)的情况可以细分2种情况：

当总体方差已知时，仍然使用正态统计量(即Z统计量)；

当总体方差未知时，则使用t统计量，t统计量服从自由度为(n-1)的学生分布(即t分布)。

上述两种情况也适用于区间估计。

各种情况下所用的检验统计量

| 检验类型                 | 统计量                                                       | 抽样分布                                            |
| ------------------------ | ------------------------------------------------------------ | --------------------------------------------------- |
| 单样本均值Z检验          | $z=\frac{\bar{x}-\mu_0}{\sigma/\sqrt{n}}$                    | 标准正态分布                                        |
| 单样本均值t检验          | $t=\frac{\bar{x}-\mu_0}{s/\sqrt{n}}$                         | 自由度为(n-1)的t分布                                |
| 单样本比例检验           | $z=\frac{p-\pi_0}{\sqrt\frac{\pi_0(1-\pi_0)}{n}}$            | 标准正态分布                                        |
| 单样本方差检验           | $\chi^2=(n-1)s^2/\sigma^2_0$                                 | 自由度为(n-1)的$\chi^2$分布                         |
| 两独立样本均值之差t检验  | $t=\frac{(\bar{x_1}-\bar{x_2})-(\mu_1-\mu_2)}{\sqrt{\frac{(n_1-1)s^2_1+(n_2-1)s^2_2}{n_1+n_2-2}}\sqrt{\frac{1}{n_1}+\frac{1}{n_2}}}$ | 自由度为$(n_1+n_2-2)$的t分布                        |
| 成对样本均值之差t检验    | $t = \frac{\sum^n_{i=1}{d_i}/{n_d-d_0}}{\sqrt{\frac{\sum^n_{i=1}(d_i-{\sum^n_{i=1}{d_i}}/n_d)}{n_d-1}}/{\sqrt{n_d}}}$ | 自由度为$(n-1)$的t分布                              |
| 两独立样本比例之差的检验 | $z=\frac{(p_1-p_2)-d_0}{\sqrt{p_1(1-p_1)/n_1+p_2(1-P_2)/n_2}}$ | 标准正态分布                                        |
| 两独立样本方差之比检验   | $F=s^2_1/s^2_2$                                              | 第一自由度为$(n_1-1)$，第二自由度为$(n_2-2)$的F分布 |

其中，$\sigma$表示总体标准差，$n_i$表示样本容量，$n_d$表示成对样本的个数，$\bar{x}、p、s^2$分别表示样本均值、样本比例和样本方差，$d_i$表示成对样本的两组变量值之差，$\mu_0、\pi_0、\sigma^2_0$分别表示原假设成立时的总体均值、总体比例和总体方差。

对于表中的检验情景，不必按照检验统计量去进行计算，只需根据python对应的数据分析工具库给出的P值结果进行判断。

## 实战

### 单总体

单总体的点估计实际就是计算对应参数的样本统计量。

单总体的区间估计是，在估计总体特征的时候依照置信度给出一个置信区间。置信区间在其他条件不变的情况下，取决于置信度水平（置信度=1-显著性水平 $\alpha$）。在大部分python分析工具库中，质询区间的置信度是由 $\alpha$ 控制的。

#### 参数估计

读取数据

```python
import pandas as pd
moisture = pd.read_csv('./data/moisture.csv')
moisture.head()
```

计算数据

```python
import pandas as pd
import statsmodels.api as sm
import scipy.stats as stats


moisture = pd.read_csv('./data/moisture.csv')
moisture.head()

# 均值
print(sm.stats.DescrStatsW(moisture['moisture']).zconfint_mean(alpha=0.05))  # Z估计求均值置信区间
print(sm.stats.DescrStatsW(moisture['moisture']).tconfint_mean(alpha=0.05))  # t估计求均值置信区间

moisture_mean, moisture_var, moisture_std = stats.bayes_mvs(moisture['moisture'], alpha=0.95)  # t分布下的均值估计，返回总体均值、总体方差和标准差的置信区间
print(moisture_mean, moisture_var, moisture_std) 

# 方差
m, v, s = stats.mvsdist(moisture['moisture'])
print(m.interval(0.95))  # 95%置信度下总体均值的置信区间
print(v.interval(0.95))  # 95%置信度下总体方差的置信区间
print(s.interval(0.95))  # 95%置信度下总体标准差置信区间

# 比例
sm.stats.proportion_confint(95, 100, alpha=0.01, method='binom_test')
# 二项分布的置信区间
# 参数
- count  成功个数
- nobs   试验总个数
- alpha  置信水平
- method 抽样分布选择
		normal：拟正态
    	agresti-coul
        wilson: wilson 结果隔离
        jeffreys:jeffrey贝叶斯
        binom_test:  二进制试验  
```

#### 假设检验

- 总体均值

1. 大样本(样本量 $n \geq 30$) ，总体方差已知

2. 大样本，总体方差未知，则用样本方差代替。

3. 小样本，总体方差已知，

三种情况下可使用服从正态分布的正态统计量（$Z$ 统计量）进行假设检验。

```python
sm.stats.DescrStatsW(moisture['moisture']).ztest_mean(value=4, alternative="larger")
# 对总体均值进行Z检验
# 返回第一个值为根据样本数据计算的Z统计量，第二个值为统计量对应的p值
# 参数
- value:平均值的假设值
- alternative：H1的假设情况
	two-sided:H1是不等于
    larger:H1是大于
    smaller:H1是小于
```

小样本，总体方差未知

```python
sm.stats.DescrStatsW(moibile['csi']).ttest_mean(value=82, alternative="larger")
# 对总体均值进行t检验
# 返回第一个值为根据样本数据计算的t统计量，第二个值为统计量对应的p值，第三个为自由度
# 参数
- value:平均值的假设值
- alternative：H1的假设情况
	two-sided:H1是不等于
    larger:H1是大于
    smaller:H1是小于
 

# 另一种测试方法
stats.ttest_1samp(a=mobile[csi], popmean=82)
# 对总体均值及性能t检验
# 返回的结果是一个对象，第一个参数是统计量值，第二个是p值
# 注意：此处的p值是双侧检验的p值，即备择假设为不等号；
# 如果备择假设为<号，
	# 当t>=0时，进行判定的单侧p值=1-Pvalue/2
    # 当t<0时，进行判定的单侧p值=Pvalue/2
# 如果备择假设为>号，
	# 当t>=0时，进行判定的单侧p值=Pvalue/2
    # 当t<0时，进行判定的单侧p值=1-Pvalue/2
```

- 总体比例

总体比例的假设检验是指根据样本数据，对总体具备某种属性的个体总数占全体属性总数的比例，提出假设并进行检验的过程。通常在大样本条件下进行。

```python
stats.binom_test(95, 100, p=0.97, alternative="greater")
# 对单总体比例进行检验
# 返回p值
# 参数
- x：成功个数
- n：试验测试
- p=0.5：成功率
- alternative="two-side"：H1的假设情况
	'two-side':双边检测
    'greater': >
    'less': <
        

# 其他测试方法
sm.stats.binom_test(95, 100, prop=0.97, alternative="larger")
sm.stats.proportions_ztest(95, 100, value=0.97, alternative="larger")
```

### 两总体

参数估计和假设检验的问题扩展到两个总体的情形：主要考察两个总体的参数是否有差异。

根据来自于总体样本数据的性质不同，分为：独立样本的统计推断、成对样本的统计推断

- 独立样本

独立样本即两组样本数据是相互独立，一个样本数据特征的变动不会影响另一个样本数据特征的变动

> 独立样本之差

一般假定两个总体均服从正态分布，使用 $t$ 统计量及性能检验

```python
import pandas as pd
import statsmodels.api as sm
import scipy.stats as stats
import numpy as np

battery = pd.read_csv('./data/battery.csv')
print(battery.head(5))
# H_0: \mu_1-\mu_2=0, H_1:\mu_1-\mu_2 \neq 0

# 1.首先对两样本总体方差是否相等(方差齐性)进行检验
# 返回一个对象，属性一是统计量的值，属性二是p值
stats.bartlett(battery[battery['tech'] == 1]['Endurance'], battery[battery['tech'] == 2]['Endurance'])
# 方法二
stats.levene(battery[battery['tech'] == 1]['Endurance'], battery[battery['tech'] == 2]['Endurance'])
# 2.样本均值的t检验
# 返回一个对象，属性一是统计量的值，属性二是p值
stats.ttest_ind(battery[battery['tech'] == 1]['Endurance'], battery[battery['tech'] == 2]['Endurance'])
# 方法二：不使用原始值直接使用统计量
ndarry1 = battery[battery['tech'] == 1]['Endurance']
ndarry2 = battery[battery['tech'] == 2]['Endurance']
count1 = ndarry1.size
count2 = ndarry2.size
mean1 = np.mean(ndarry1)
mean2 = np.mean(ndarry2)
std1 = np.std(ndarry1)
std2 = np.std(ndarry2)
print(stats.ttest_ind_from_stats(mean1, std1, count1, mean2, std2, count2))

# statsmodels也提供了测样本均值的t校验
sm.stats.ttest_ind(battery[battery['tech'] == 1]['Endurance'], battery[battery['tech'] == 2]['Endurance'], alternative="two-sided", usevar='pooled', value=0)
# 返回三个值：t统计量值，p值，计算t统计量的自由度
# 参数
- x: 样本一的数据
- y: 样本二的数据
- alternative: H1的假设情况，two-sided:双边检测；larger:H1是>;smaller:H1是<
- usevar:总体方差是否相等，pooled:相等，unequal:不相等
- value:假设均值下的差值
```

> 独立样本比例之差

独立样本比例之差的假设检验主要考察两个总体比例是否有差异或检验其差异的具体数值。这里的比例仍然是指总体只具备两种属性，其中巨笔某种属性的个体数目占总体数目的比重，即假定两个总体都服从二项分布，通常用 $Z$ 统计量进行检验

```python

```

- 成对样本